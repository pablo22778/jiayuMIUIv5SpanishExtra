#!/system/bin/sh

#Nos entropy Generator engine for Fly-On Mod™ by Slaid480
#Copyright (C) 2013 Jeffrey Gomez (Exit_Only)

#  This program is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
#  GNU General Public License for more details.

#  You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.

#===============================================================#

clear
   echo ""
   echo "==========================================="
   echo "==       ENTROPY GENERATOR SWITCH        =="
   echo "==       For Fly-On Mod™ by Slaid480     =="
   echo "==       Thanks to Exit_Only @ XDA 2013  =="
   echo "==========================================="
sleep 1
   echo ""
   echo "Turning Entropy generator switch on..."
sleep 1
busybox mount -o rw,remount /system
busybox rm -f /data/Fly-On/S08_rngd.log
busybox touch /data/Fly-On/S08_rngd.log
   echo ""
   echo "Checking for qrngd binary [ Qualcomm devices ONLY ] ..."
sleep 1
if [ -e /system/bin/qrngd ]; then
   echo ""
   echo "Backing up & removing qrngd binary [ Qualcomm devices ONLY ] ..."
sleep 1
cp /system/bin/qrngd /system/etc/entropy/grngd_bin
busybox rm -f /system/bin/qrngd
fi
if [ -e /system/xbin/qrngd ]; then
   echo ""
   echo "Backing up & removing qrngd binary [ Qualcomm devices ONLY ] ..."
sleep 1
cp /system/xbin/qrngd /system/etc/entropy/qrngd_xbin
busybox rm -f /system/xbin/qrngd
fi
   echo ""
   echo "Activating 'rngd' binary & setting proper governor values..."
sleep 1
STATE=/data/Fly-On/rngd_state
busybox rm -f $STATE
busybox touch $STATE
echo "# Fly-On" >> $STATE
echo "" >> $STATE
echo "Rngd binary: 'ON'" >> $STATE
echo "" >> $STATE
echo "Rngd binary state: 'ACTIVE' " >> $STATE
echo "" >> $STATE
echo "Rngd binary governor: 'DEFAULT' " >> $STATE
cp /system/etc/entropy/rngd_script /system/etc/init.d/S08_rngd
busybox chmod -f 777 /system/etc/init.d/S08_rngd
busybox chown -f 0.0 /system/etc/init.d/S08_rngd
cp /system/etc/entropy/rngd /system/bin
busybox chmod -f 777 /system/bin/rngd
busybox chown -f 0.0 /system/bin/rngd
cp /system/etc/entropy/entro /system/bin
busybox chmod -f 777 /system/bin/entro
busybox chown -f 0.0 /system/bin/entro
   echo ""
   echo "'rngd' binary is now active & proper 'rngd' values have been set..."
sleep 1
   echo ""
   echo "This switch WILL survive a full reboot..."
sleep 1
   echo ""
   echo "You MUST turn the switch off in order to de-activate the rngd binary..."
sleep 1
   echo ""
   echo "Type 'su' then type 'rngd_off' to de-activate rngd binary..."
sleep 2
   echo ""
   echo "Do you want to 'Hard Reboot' or 'Soft Reboot?"
sleep 1
   echo ""
   echo -n "Please select an option: [ Hard Reboot = 1 | Soft Reboot = 2 ]: "
read option2
if [ $option2 -ne 1 ]; then
killall -9 system_server
else
reboot
busybox reboot
fi